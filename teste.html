<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fid√©lit√© Boulangerie</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    body {
      margin: 0;
      background: #f7f3ef;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 420px;
      text-align: center;
      margin-bottom: 30px;
    }
    h1 {
      color: #b96f2b;
      margin-bottom: 10px;
    }
    #user-info, #admin-panel, #admin-login {
      display: none;
    }
    #user-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-bottom: 8px;
    }
    button {
      background: #b96f2b;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.2s;
      margin: 4px;
    }
    button:hover {
      background: #a25f24;
    }
    .balance {
      font-size: 22px;
      font-weight: bold;
      color: #3c3c3c;
      margin: 10px 0;
    }
    #history {
      margin-top: 16px;
      text-align: left;
      font-size: 14px;
      background: #fafafa;
      border-radius: 8px;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
    .logout {
      background: #999;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border-bottom: 1px solid #ddd;
      padding: 6px;
    }
    th {
      background: #f2f2f2;
    }
    input[type="password"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      margin: 8px 0;
    }
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>

  <div class="card" id="client-card">
    <h1>Fid√©lit√© Boulangerie ü•ê</h1>

    <!-- Connexion Google -->
    <div id="g_id_onload"
      data-client_id="18561024329-544frib33m4a7la7rflg3slrt3718hr5.apps.googleusercontent.com"
      data-context="signin"
      data-ux_mode="popup"
      data-callback="handleCredentialResponse"
      data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
      data-type="standard"
      data-shape="rectangular"
      data-theme="outline"
      data-text="signin_with"
      data-size="large">
    </div>

    <!-- Tableau de bord utilisateur -->
    <div id="user-info">
      <img id="user-photo" alt="photo">
      <h2 id="user-name"></h2>
      <p class="balance">Cagnotte : <span id="user-balance">0.00</span> ‚Ç¨</p>
      <button id="addPoints">+ Ajouter 1‚Ç¨ de cagnotte</button>
      <button id="usePoints">- Utiliser 1‚Ç¨</button>
      <button class="logout" id="logoutBtn">Se d√©connecter</button>
      <div id="history"></div>
    </div>

    <hr style="margin: 16px 0;">
    <button id="adminAccessBtn">üîë Espace administrateur</button>
  </div>

  <!-- Login admin -->
  <div class="card" id="admin-login">
    <h2>Connexion administrateur</h2>
    <input type="password" id="adminPassword" placeholder="Mot de passe admin">
    <button id="adminLoginBtn">Se connecter</button>
    <button class="logout" id="adminCancelBtn">Annuler</button>
  </div>

  <!-- Panneau admin -->
  <div class="card" id="admin-panel">
    <div class="admin-header">
      <h2>üë©‚Äçüç≥ Espace Admin</h2>
      <button class="logout" id="closeAdmin">Quitter</button>
    </div>
    <table id="clientsTable">
      <thead>
        <tr><th>Nom</th><th>Email</th><th>Solde (‚Ç¨)</th><th>+/-</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <p style="margin-top:10px; font-size:14px;">
      üí∞ Total cagnottes : <b id="totalBalance">0.00‚Ç¨</b>
    </p>
  </div>

  <script>
    const ADMIN_PASSWORD = "admin123";

    const balanceEl = document.getElementById('user-balance');
    const userInfoEl = document.getElementById('user-info');
    const historyEl = document.getElementById('history');
    let user = null;

    // ---------------------------
    // Connexion Google
    // ---------------------------
    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);
      user = {
        id: data.sub,
        name: data.name,
        email: data.email,
        photo: data.picture,
      };
      saveOrLoadUser();
      displayUserInfo();
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    // ---------------------------
    // Donn√©es utilisateur
    // ---------------------------
    function saveOrLoadUser() {
      const key = 'user_' + user.id;
      const savedData = JSON.parse(localStorage.getItem(key));
      if (savedData) {
        user = savedData;
      } else {
        user.balance = 0;
        user.history = [];
        localStorage.setItem(key, JSON.stringify(user));
      }
    }

    function updateUserData() {
      localStorage.setItem('user_' + user.id, JSON.stringify(user));
    }

    function displayUserInfo() {
      document.querySelector('.g_id_signin').style.display = 'none';
      userInfoEl.style.display = 'block';
      document.getElementById('user-name').textContent = user.name;
      document.getElementById('user-photo').src = user.photo;
      balanceEl.textContent = user.balance.toFixed(2);
      renderHistory();
    }

    function renderHistory() {
      historyEl.innerHTML = '';
      user.history.slice().reverse().forEach(item => {
        const p = document.createElement('p');
        p.textContent = `${item.date} - ${item.action} (${item.amount > 0 ? '+' : ''}${item.amount}‚Ç¨)`;
        historyEl.appendChild(p);
      });
    }

    document.getElementById('addPoints').addEventListener('click', () => {
      user.balance += 1;
      user.history.push({ date: new Date().toLocaleDateString(), action: 'Ajout de cagnotte', amount: 1 });
      balanceEl.textContent = user.balance.toFixed(2);
      updateUserData();
      renderHistory();
    });

    document.getElementById('usePoints').addEventListener('click', () => {
      if (user.balance >= 1) {
        user.balance -= 1;
        user.history.push({ date: new Date().toLocaleDateString(), action: 'Utilisation', amount: -1 });
        balanceEl.textContent = user.balance.toFixed(2);
        updateUserData();
        renderHistory();
      } else {
        alert("Pas assez de cagnotte üòÖ");
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      google.accounts.id.disableAutoSelect();
      userInfoEl.style.display = 'none';
      document.querySelector('.g_id_signin').style.display = 'block';
      user = null;
    });

    // ---------------------------
    // Acc√®s Admin
    // ---------------------------
    const adminLoginCard = document.getElementById('admin-login');
    const adminPanel = document.getElementById('admin-panel');
    const clientCard = document.getElementById('client-card');

    document.getElementById('adminAccessBtn').addEventListener('click', () => {
      clientCard.style.display = 'none';
      adminLoginCard.style.display = 'block';
    });

    document.getElementById('adminCancelBtn').addEventListener('click', () => {
      adminLoginCard.style.display = 'none';
      clientCard.style.display = 'block';
    });

    document.getElementById('adminLoginBtn').addEventListener('click', () => {
      const pass = document.getElementById('adminPassword').value.trim();
      if (pass === ADMIN_PASSWORD) {
        adminLoginCard.style.display = 'none';
        adminPanel.style.display = 'block';
        loadClients();
      } else {
        alert("Mot de passe incorrect ‚ö†Ô∏è");
      }
    });

    document.getElementById('closeAdmin').addEventListener('click', () => {
      adminPanel.style.display = 'none';
      clientCard.style.display = 'block';
    });

    // ---------------------------
    // Panneau Admin
    // ---------------------------
    function loadClients() {
      const tableBody = document.querySelector('#clientsTable tbody');
      tableBody.innerHTML = '';
      let total = 0;
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith('user_')) {
          const u = JSON.parse(localStorage.getItem(key));
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.balance.toFixed(2)}</td>
            <td>
              <button onclick="modifyBalance('${u.id}',1)">+1</button>
              <button onclick="modifyBalance('${u.id}',-1)">-1</button>
            </td>
          `;
          tableBody.appendChild(tr);
          total += u.balance;
        }
      });
      document.getElementById('totalBalance').textContent = total.toFixed(2) + "‚Ç¨";
    }

    window.modifyBalance = function(id, delta) {
      const key = 'user_' + id;
      const u = JSON.parse(localStorage.getItem(key));
      if (!u) return;
      u.balance = Math.max(0, u.balance + delta);
      u.history.push({ date: new Date().toLocaleDateString(), action: delta > 0 ? "Ajout (admin)" : "Retrait (admin)", amount: delta });
      localStorage.setItem(key, JSON.stringify(u));
      loadClients();
      if (user && user.id === id) {
        user = u;
        balanceEl.textContent = user.balance.toFixed(2);
        renderHistory();
      }
    }
  </script>
</body>
</html>
